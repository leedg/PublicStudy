# =============================================================================
# NetworkModuleTest - Docker Compose (3-tier integration test)
# =============================================================================
# English: Services: dbserver → server → client_epoll / client_iouring
# 한글: 서비스: dbserver → server → client_epoll / client_iouring
#
# HOW RESULTS ARE SAVED:
#   client_epoll / client_iouring mount ../Doc/Performance/Logs into the container.
#   entrypoint_client.sh writes results to /workspace/Doc/Performance/Logs/<timestamp>/.
#   Because of the volume mount, files are written directly to the Windows host.
#   run_docker_test.ps1 -Push then commits and pushes those new log files.
#
# 결과 저장 방식:
#   client 서비스들이 ../Doc/Performance/Logs를 컨테이너에 마운트.
#   entrypoint_client.sh가 /workspace/Doc/Performance/Logs/<timestamp>/에 결과 기록.
#   볼륨 마운트로 파일이 Windows 호스트에 직접 저장됨.
#   run_docker_test.ps1 -Push가 새 로그 파일을 커밋/푸시.
#
# Usage:
#   .\test_linux\run_docker_test.ps1              # build + test + no push
#   .\test_linux\run_docker_test.ps1 -Push        # build + test + auto push results
#   .\test_linux\run_docker_test.ps1 -NoBuild -Push

services:

  # ---------------------------------------------------------------------------
  # English: Build stage — compiles all binaries
  # 한글: 빌드 스테이지 — 모든 바이너리 컴파일
  # ---------------------------------------------------------------------------
  build:
    build:
      context: ..
      dockerfile: test_linux/Dockerfile
    command: ["/workspace/test_linux/scripts/build.sh"]
    profiles: ["build"]

  # ---------------------------------------------------------------------------
  # English: DBServer — runs on port 9001
  # 한글: DBServer — 포트 9001에서 실행
  # ---------------------------------------------------------------------------
  dbserver:
    build:
      context: ..
      dockerfile: test_linux/Dockerfile
    command: >
      bash -c "/workspace/test_linux/scripts/build.sh &&
               /workspace/build/linux/DBServer -p 9001 -l INFO"
    networks:
      - testnet
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/9001"]
      interval: 3s
      timeout: 2s
      retries: 10

  # ---------------------------------------------------------------------------
  # English: TestServer — runs on port 9000, connects to dbserver:9001
  # 한글: TestServer — 포트 9000 실행, dbserver:9001 연결
  # ---------------------------------------------------------------------------
  server:
    build:
      context: ..
      dockerfile: test_linux/Dockerfile
    command: >
      bash -c "/workspace/test_linux/scripts/build.sh &&
               /workspace/build/linux/TestServer -p 9000 --db-host dbserver --db-port 9001 -l INFO"
    depends_on:
      dbserver:
        condition: service_healthy
    networks:
      - testnet
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/9000"]
      interval: 3s
      timeout: 2s
      retries: 10

  # ---------------------------------------------------------------------------
  # English: Client (epoll backend)
  # 한글: 클라이언트 (epoll 백엔드)
  #
  # Volume: ../Doc/Performance/Logs → /workspace/Doc/Performance/Logs
  #   Results written inside container appear directly on the Windows host.
  #   볼륨: 컨테이너 내부 결과가 Windows 호스트에 직접 기록됨.
  # ---------------------------------------------------------------------------
  client_epoll:
    build:
      context: ..
      dockerfile: test_linux/Dockerfile
    entrypoint: ["/workspace/test_linux/scripts/entrypoint_client.sh"]
    environment:
      SERVER_HOST: server
      SERVER_PORT: "9000"
      BACKEND: epoll
      NUM_CLIENTS: "10"
      NUM_PINGS: "5"
      LOG_SESSION: "${LOG_SESSION:-}"   # English: injected by run_docker_test.ps1 / 한글: ps1 스크립트가 주입
    volumes:
      - ../Doc/Performance/Logs:/workspace/Doc/Performance/Logs
    depends_on:
      server:
        condition: service_healthy
    networks:
      - testnet

  # ---------------------------------------------------------------------------
  # English: Client (io_uring backend)
  # 한글: 클라이언트 (io_uring 백엔드)
  # ---------------------------------------------------------------------------
  client_iouring:
    build:
      context: ..
      dockerfile: test_linux/Dockerfile
    entrypoint: ["/workspace/test_linux/scripts/entrypoint_client.sh"]
    environment:
      SERVER_HOST: server
      SERVER_PORT: "9000"
      BACKEND: iouring
      NUM_CLIENTS: "10"
      NUM_PINGS: "5"
      LOG_SESSION: "${LOG_SESSION:-}"
    volumes:
      - ../Doc/Performance/Logs:/workspace/Doc/Performance/Logs
    depends_on:
      server:
        condition: service_healthy
    networks:
      - testnet

networks:
  testnet:
    driver: bridge
